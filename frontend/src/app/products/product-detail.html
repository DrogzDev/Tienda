<!-- Crear producto (UI mejorada, mismos campos/requerimientos) -->
<div class="space-y-4">

  <!-- Main -->
  <section class="flex-1 min-w-0">
    <!-- Topbar -->
    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6">
      <div class="flex items-center gap-2">
        <button class="md:hidden mr-1 w-9 h-9 rounded-xl border border-slate-200 grid place-content-center"
                (click)="toggleSidebar()" aria-label="Abrir menú" title="Abrir menú">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
            <path d="M4 7h16M4 12h16M4 17h16"/>
          </svg>
        </button>

        <div class="text-slate-700 font-semibold">Editar producto</div>
      </div>

      <div class="flex items-center gap-2">
        <!-- NUEVO: Eliminar producto -->
        <button class="px-3 py-2.5 rounded-xl border border-rose-300 text-rose-700 hover:bg-rose-50 transition-all duration-300 disabled:opacity-50"
                (click)="deleteProduct()"
                [disabled]="deletingProd() || saving()">
          <span *ngIf="deletingProd(); else delTxt" class="inline-flex items-center gap-2">
            <svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Eliminando…
          </span>
          <ng-template #delTxt>Eliminar</ng-template>
        </button>

        <div class="hidden md:flex items-center gap-2 rounded-xl bg-slate-100 px-3 py-2">
          <svg class="w-4 h-4 text-slate-500" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-5-5z"/></svg>
          <input placeholder="Buscar…" class="bg-transparent outline-none text-sm w-56" />
        </div>
        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-fuchsia-500 to-sky-500"></div>
      </div>
    </header>

      <!-- Header mejorado -->
      <div class="flex items-center justify-between mb-6">
        <a routerLink="/products" 
           class="flex items-center gap-2 px-4 py-2.5 rounded-xl border border-slate-300 hover:bg-slate-50 transition-all duration-300 group">
          <svg class="w-4 h-4 group-hover:-translate-x-0.5 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Volver a Productos
        </a>
        <button class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 text-white font-medium hover:from-blue-700 hover:to-blue-800 transition-all duration-300 shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                [disabled]="saving()"
                (click)="save()">
          <span *ngIf="saving()" class="flex items-center gap-2">
            <svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Guardando…
          </span>
          <span *ngIf="!saving()">Guardar cambios</span>
        </button>
      </div>

      <div class="grid gap-6" style="grid-template-columns: 1.2fr .8fr;">
        <!-- Form mejorado -->
        <form [formGroup]="form" class="bg-white border border-slate-200 rounded-2xl p-6 shadow-soft hover:shadow-md transition-shadow duration-300">
          <h3 class="text-lg font-semibold mb-4 text-slate-800 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 5h18v14H3V5zm2 2v10h14V7H5z"/>
            </svg>
            Información del producto
          </h3>

          <div class="grid gap-4" style="grid-template-columns: 1fr 1fr;">
            <label class="text-sm font-medium text-slate-700">
              SKU
              <input class="mt-1 w-full rounded-xl border border-slate-300 px-4 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300"
                     type="text" formControlName="sku" placeholder="Ej: PROD-001">
            </label>
            <label class="text-sm font-medium text-slate-700">
              Nombre
              <input class="mt-1 w-full rounded-xl border border-slate-300 px-4 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300"
                     type="text" formControlName="name" placeholder="Nombre del producto">
            </label>

            <!-- Precio USD mejorado -->
            <label class="text-sm font-medium text-slate-700">
              Precio USD
              <div class="relative mt-1">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-500">$</span>
                <input class="w-full rounded-xl border border-slate-300 pl-8 pr-4 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300"
                       type="number" step="0.01" min="0" formControlName="price_usd" placeholder="0.00">
              </div>
            </label>
          </div>

          <label class="block mt-4 text-sm font-medium text-slate-700">
            Descripción
            <textarea rows="4" 
                      class="mt-1 w-full rounded-xl border border-slate-300 px-4 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300"
                      formControlName="description"
                      placeholder="Describe las características del producto..."></textarea>
          </label>

          <div class="mt-6">
            <div class="text-sm font-medium text-slate-700 mb-3 flex items-center gap-2">
              <svg class="w-4 h-4 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7 5h10v2H7zM7 9h10v2H7zM7 13h10v2H7zM3 17h18v2H3z"/>
              </svg>
              Categorías
            </div>
            <div class="flex flex-wrap gap-3">
              <label *ngFor="let category of categories" 
                     class="inline-flex items-center gap-2 text-sm px-3 py-2 rounded-lg border border-slate-300 hover:bg-slate-50 transition-colors duration-300 cursor-pointer">
                <input type="checkbox"
                       [value]="category.id"
                       [checked]="isCategorySelected(category.id)"
                       (change)="toggleCategory(category.id)"
                       class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                {{ category.name }}
              </label>
            </div>
          </div>
        </form>

        <!-- Imagen mejorada -->
        <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-soft hover:shadow-md transition-shadow duration-300">
          <h3 class="text-lg font-semibold mb-4 text-slate-800 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM5 19V5h14v14H5z"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <path d="M21 15l-5-5-5 5-3-3-3 3V5h2v10l1-1 3 3 5-5 5 5z"/>
            </svg>
            Imagen del producto
          </h3>
          
          <div class="flex items-center gap-6">
            <div class="relative group">
              <img [src]="imageUrl || '/assets/placeholder-product.png'"
                   alt="Vista previa del producto" 
                   class="w-40 h-40 object-cover rounded-xl border-2 border-slate-200 group-hover:border-blue-300 transition-colors duration-300">
              <div *ngIf="!imageUrl" class="absolute inset-0 bg-slate-100 rounded-xl flex items-center justify-center">
                <svg class="w-12 h-12 text-slate-400" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM5 19V5h14v14H5z"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <path d="M21 15l-5-5-5 5-3-3-3 3V5h2v10l1-1 3 3 5-5 5 5z"/>
                </svg>
              </div>
            </div>
            
            <div class="space-y-3 flex-1">
              <label class="block">
                <input type="file" accept="image/*" (change)="onImageChange($event)"
                       class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors duration-300">
              </label>
              
              <button class="w-full px-4 py-2.5 rounded-xl border border-slate-300 text-slate-700 hover:bg-slate-50 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed font-medium"
                      [disabled]="!imageUrl || deletingImg()" 
                      (click)="deleteImage()">
                <span *ngIf="deletingImg()" class="flex items-center gap-2 justify-center">
                  <svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Quitando…
                </span>
                <span *ngIf="!deletingImg()">Quitar imagen</span>
              </button>
              
              <div class="text-xs text-slate-500 bg-slate-50 rounded-lg p-3">
                <strong>Recomendaciones:</strong> JPG o PNG. Tamaño ideal 640×640 píxeles. Máx. 2MB.
              </div>
            </div>
          </div>
        </div>
      </div>

<!-- Stock por sede mejorado -->
<div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-soft hover:shadow-md transition-shadow duration-300 mt-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
      <svg class="w-5 h-5 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
        <path d="M4 17h16v2H4zM5 5h14v10H5z"/>
      </svg>
      Stock por almacén
    </h3>

    <div class="flex items-center gap-3">
      <select class="rounded-xl border border-slate-300 px-4 py-2.5 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300" #addSel>
        <option value="">Seleccionar sede…</option>
        <option *ngFor="let s of storesMissing()" [value]="s.id">
          {{ s.name }} ({{ s.code }})
        </option>
      </select>

      <button class="px-4 py-2.5 rounded-xl border border-slate-300 bg-white text-slate-700 hover:bg-slate-50 transition-all duration-300 font-medium"
              (click)="addStore(addSel)">
        Agregar sede
      </button>
    </div>
  </div>

  <div *ngIf="!product?.stocks_detail?.length"
       class="text-center py-8 text-slate-500 border-2 border-dashed border-slate-200 rounded-xl">
    <svg class="w-12 h-12 mx-auto text-slate-400 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M3 5h18v14H3zM8 7v10m4-10v10m4-10v10"/>
    </svg>
    <p class="font-medium">No hay registros de stock</p>
    <p class="text-sm mt-1">Agrega sedes para gestionar el inventario</p>
  </div>

  <table *ngIf="product?.stocks_detail?.length" class="w-full text-sm">
    <thead class="text-slate-600 bg-slate-50 rounded-xl">
      <tr>
        <th class="text-left py-3 px-4 rounded-l-xl">Sede</th>
        <th class="text-right py-3 px-4">Cantidad</th>
        <th class="text-right py-3 px-4">Mín. alerta</th>
        <th class="text-right py-3 px-4">Guardar cambios</th>
        <th class="text-right py-3 px-4 rounded-r-xl">Ajuste ±</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let r of product.stocks_detail"
          class="border-b border-slate-100 hover:bg-slate-50 transition-colors duration-300">
        <!-- Sede -->
        <td class="py-3 px-4 font-medium">
          {{ r.store_code }}
        </td>

        <!-- Cantidad editable -->
        <td class="py-3 px-4 text-right">
          <input type="number"
                 #qty
                 [value]="r.quantity"
                 min="0"
                 class="w-24 text-right rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300">
        </td>

        <!-- Min alert editable -->
        <td class="py-3 px-4 text-right">
          <input type="number"
                 #min
                 [value]="r.min_threshold"
                 min="0"
                 class="w-24 text-right rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300">
        </td>

        <!-- Guardar cambios (usa tu TS: setStock) -->
        <td class="py-3 px-4 text-right">
          <button
            class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition-all duration-300 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
            [disabled]="saving()"
            (click)="setStock(r, qty, min)">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V7l-4-4z"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 21v-8H7v8"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M7 3v4h8"/>
            </svg>
            Guardar
          </button>
        </td>

        <!-- Ajuste ± (input por fila) -->
        <td class="py-3 px-4 text-right">
          <div class="inline-flex items-center justify-end gap-2">
            <button
              type="button"
              class="h-10 w-10 inline-flex items-center justify-center rounded-xl border border-slate-300 bg-white hover:bg-slate-50 transition-all duration-300 text-base font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
              [disabled]="saving()"
              (click)="applyDelta(r, -1)">
              −
            </button>

            <button
              type="button"
              class="h-10 w-10 inline-flex items-center justify-center rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition-all duration-300 text-base font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
              [disabled]="saving()"
              (click)="applyDelta(r, 1)">
              +
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>
